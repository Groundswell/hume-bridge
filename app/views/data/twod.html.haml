

%html
	%head
		:css
			body {
				padding: 0;
				margin: 0;
				background: #eaeaea;
				width: 100vw;
				height: 100vh;
			}
			.grid {
				position: absolute;
				top: 0;
				left: 50vw;
				height: 50vh;
				width: 50vw;
				background: #eeeeee;
			}
			.circle {
				border-radius: 50%;
				background: black;
				width: 2px;
				height: 2px;
				position: absolute;
			}

	%body
		%div.grid
		= javascript_include_tag 'https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js'
		:javascript

			function color_from_integer( i ) {

				var r = 0
				var g = 0
				var b = 0

				if( i < 256 ) {
					r = i
				} else if( i < 512 ) {
					r = 255
					g = (i - 255)
				} else if( i < 768 ) {
					r = 255 - (i - 511)
					g = 255
				} else if( i < 1024 ) {
					g = 255
					b = (i - 768)
				} else if( i < 1280 ) {
					g = 255 - (i - 1023)
					b = 255
				} else if( i < 1536 ) {
					b = 255
					r = (i - 1280)
				} else if( i < 1792 ) {
					b = 255 - (i - 1535)
					r = 255
				}


				return "rgb("+r+","+g+","+b+")"
			}

			function render_data_point( data_point, left, bottom, delay, color ) {
				setTimeout(function(){
					$('.grid').append('<div class="circle" style="left:'+left+'px;bottom:'+bottom+'px;background:'+color+'"></div>')
					if ( $('.grid>.circle').length > 20 )
						$('.grid>.circle').first().remove();
				}, delay )
			}

			function render_data() {
				$('.grid').html('')
				var dims = [ 'acceleration_#{(params[:dims]||'x,y').split(',').first}axis', 'acceleration_#{(params[:dims]||'x,y').split(',').last}axis' ]

				var per_second = 8
				var seconds_per = 1 / per_second

				var left_acceleration = 0;
				var bottom_acceleration = 0;

				var left_velocity = 0
				var bottom_velocity = 0

				var left_position = 0;
				var bottom_position = 0;

				var last_data_point = null;
				$.getJSON( "#{raw data_path( params.permit( :dims, :limit ).merge( format: :json, tags: params[:tags] ) )}", function( data ) {
					console.log(data)
					$(data).each(function(index,data_point){

						var delta_left_acceleration   = data_point[ dims[0] ] - ( last_data_point || data_point )[ dims[0] ]
						var delta_bottom_acceleration = data_point[ dims[1] ] - ( last_data_point || data_point )[ dims[1] ]

						// left_acceleration   += delta_left_acceleration
						// bottom_acceleration += delta_bottom_acceleration
						// left_velocity   += left_acceleration * 9.8 * seconds_per
						// bottom_velocity += bottom_acceleration * 9.8 * seconds_per
						// left_position += left_velocity * 10
						// bottom_position += bottom_velocity * 10

						left_position   += delta_left_acceleration * 100
						bottom_position += delta_bottom_acceleration * 100

						render_data_point( data_point, left_position, bottom_position, (index * seconds_per * 1000), color_from_integer(index) )

						last_data_point = data_point

					})
				});
			}
			render_data();
